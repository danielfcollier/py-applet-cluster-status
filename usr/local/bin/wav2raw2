#!/bin/bash

ARGS=1 #número minimo de args. existe tres arg. opcional
E_BADARGS=65
E_NODIR=66

#Verifica se os parametros estao na quantidade desejada.
if [[ $# -lt $ARGS || $# -gt $((ARGS+3)) ]]
then
  echo "Uso: `basename $0` diretorio [-v]"
  exit $E_BADARGS
fi

#Alerta de uso incorreto do segundo parämetro.
if [[ -n $2 && "$2" != "-v" && "$2" != "-r" ]];
then
  echo "Uso: `basename $0` diretorio [ [-r taxa] -v ]"
  exit $E_BADARGS
fi

#Testa existëncia do diretório
if [ ! -d "$1" ]
then
  echo "Dir \"$1\" nao existe."
  exit $E_NODIR
fi 

LIST=`ls $1/*.wav`

#Testa a existencia do terceiro parametro.
if [[ "$2" = "-r" && "$3" = "" ]];
then
  echo "Uso: `basename $0` diretorio [ [-r taxa] -v ]"
  exit $E_NODIR
fi 
    
#Alerta o usuario de uso incorreto do terceiro parametro.
if [[ -n $3 && $3 -lt 0 ]]
then
  echo "Uso: `basename $0` diretorio [ [-r taxa] -v ]"
  echo "Valor para taxa fora do padrao."
  exit $E_BADARGS
fi


#Alerta de uso incorreto do quarto parämetro.
if [[ -n $4 && "$4" != "-v" ]];
then
  echo "Uso: `basename $0` diretorio [ [-r taxa] -v ]"
  exit $E_BADARGS
fi

#Alerta de uso adicional de parametro caso a
#opcão seja apenas saber a quantidade de conversões.
if [ "$2" = "-v" ];then	
  if [[ $# -lt $ARGS || $# -gt $((ARGS+1)) ]]
  then
    echo "Uso: `basename $0` diretorio [ [-r taxa] -v]"
    exit $E_BADARGS
  fi
fi

#Converte de wav para raw.
if [[ "$2" = "" || "$2" = "-v" ]]; 
then
conta=0
for i in $LIST; 
do
    sox $i ${i%wav}raw
    conta=$((conta+1))
done
fi

#Converte com a taxa de amostragem desejada 
#e conta os arquivos convertidos.
if [ "$2" = "-r" ]; 
then
taxa=$3
for i in $LIST; 
do
    sox $i -r $taxa ${i%wav}raw resample -qs
    conta=$((conta+1))
done
fi

#Imprime na tela(OPCIONAL).
if [[ "$2" = "-v" || "$4" = "-v" ]]; then
    echo "Arquivos convertidos:" $conta
fi

